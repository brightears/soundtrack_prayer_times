<%- include('_head') %>

<div class="page-header">
  <div class="page-header__top">
    <div>
      <h1 class="page-header__title"><%= zone ? 'Edit' : 'Add' %> Zone</h1>
      <p class="page-header__subtitle"><%= zone ? 'Update configuration for ' + zone.zone_name : 'Configure a new sound zone for prayer time scheduling' %></p>
    </div>
    <div class="page-header__actions">
      <a href="<%= basePath %>" class="btn btn--ghost">Back to Dashboard</a>
    </div>
  </div>
</div>

<% if (error) { %>
  <div class="alert alert--error"><%= error %></div>
<% } %>

<form method="POST" action="<%= zone ? basePath + '/zones/' + zone.id + '/update' : basePath + '/zones/create' %>" id="zone-form" style="max-width: 720px;">

  <% if (!zone) { %>
  <!-- Zone Selection (account locked) -->
  <div class="form-section">
    <div class="form-section__title">Sound Zone</div>

    <div class="field">
      <label class="field__label">Account</label>
      <p style="margin: 0;"><span class="text-bold"><%= customer.account_name %></span></p>
    </div>

    <div class="field">
      <label class="field__label field__label--required">Zone</label>
      <select name="zone_id" id="zone-select" class="field__select" required>
        <option value="">Loading zones...</option>
      </select>
    </div>

    <input type="hidden" name="location_id" id="location-id">
    <input type="hidden" name="location_name" id="location-name">
    <input type="hidden" name="zone_name" id="zone-name">
  </div>
  <% } else { %>
  <div class="form-section">
    <div class="form-section__title">Sound Zone</div>
    <p style="margin: 0;"><span class="text-bold"><%= zone.zone_name %></span> <span class="text-muted">(<%= customer.account_name %>)</span></p>
  </div>
  <% } %>

  <!-- Prayer Time Location -->
  <div class="form-section">
    <div class="form-section__title">Prayer Time Location</div>

    <div class="grid-2">
      <div class="field">
        <label class="field__label field__label--required">City</label>
        <input type="text" name="city" class="field__input" value="<%= zone ? zone.city : '' %>" required placeholder="e.g. Bangkok">
      </div>
      <div class="field">
        <label class="field__label field__label--required">Country</label>
        <input type="text" name="country" class="field__input" value="<%= zone ? zone.country : '' %>" required placeholder="e.g. Thailand">
      </div>
    </div>

    <div class="field">
      <label class="field__label field__label--required">Timezone</label>
      <select name="timezone" class="field__select" required>
        <option value="">Select timezone</option>
        <% const timezones = [
          'Asia/Jakarta', 'Asia/Makassar', 'Asia/Jayapura',
          'Asia/Kuala_Lumpur', 'Asia/Singapore',
          'Asia/Bangkok', 'Asia/Ho_Chi_Minh',
          'Asia/Manila', 'Asia/Phnom_Penh',
          'Asia/Yangon', 'Asia/Kolkata',
          'Asia/Dubai', 'Asia/Riyadh', 'Asia/Qatar',
          'Asia/Karachi', 'Asia/Dhaka',
          'Asia/Tokyo', 'Asia/Seoul', 'Asia/Shanghai',
          'Asia/Hong_Kong', 'Asia/Taipei',
          'Europe/Istanbul', 'Europe/London', 'Europe/Paris',
          'Africa/Cairo', 'Africa/Casablanca',
          'America/New_York', 'America/Los_Angeles',
          'Australia/Sydney', 'Pacific/Auckland'
        ]; %>
        <% for (const tz of timezones) { %>
          <option value="<%= tz %>" <%= zone && zone.timezone === tz ? 'selected' : '' %>><%= tz %></option>
        <% } %>
      </select>
    </div>

    <div class="grid-2">
      <div class="field">
        <label class="field__label field__label--required">Calculation Method</label>
        <select name="method" class="field__select" required>
          <% for (const [id, name] of Object.entries(methods)) { %>
            <option value="<%= id %>" <%= zone && zone.method === Number(id) ? 'selected' : (!zone && id === '4' ? 'selected' : '') %>><%= name %></option>
          <% } %>
        </select>
      </div>
      <div class="field">
        <label class="field__label">Asr Calculation</label>
        <select name="asr_school" class="field__select">
          <option value="0" <%= !zone || zone.asr_school === 0 ? 'selected' : '' %>>Shafi'i (standard)</option>
          <option value="1" <%= zone && zone.asr_school === 1 ? 'selected' : '' %>>Hanafi</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Schedule Settings -->
  <div class="form-section">
    <div class="form-section__title">Schedule Settings</div>

    <div class="field">
      <label class="field__label">Prayers to Pause For</label>
    </div>

    <% const allPrayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
       const enabledPrayers = zone ? zone.prayers.split(',').map(p => p.trim()) : allPrayers;
       const defaultDurations = { Fajr: 15, Dhuhr: 20, Asr: 15, Maghrib: 15, Isha: 20 };
       const durations = zone && zone.pause_durations ? zone.pause_durations : defaultDurations; %>

    <div class="data-table--wrapper" style="margin-bottom: var(--space-6);">
      <table class="data-table">
        <thead>
          <tr>
            <th>Prayer</th>
            <th>Enabled</th>
            <th>Duration (min)</th>
          </tr>
        </thead>
        <tbody>
          <% for (const prayer of allPrayers) { %>
          <tr>
            <td class="text-bold"><%= prayer %></td>
            <td>
              <label class="field__check">
                <input type="checkbox" name="prayer_<%= prayer %>" value="1"
                  <%= enabledPrayers.includes(prayer) ? 'checked' : '' %>>
              </label>
            </td>
            <td>
              <input type="number" name="duration_<%= prayer %>" class="field__input"
                min="5" max="60"
                value="<%= durations[prayer] || defaultDurations[prayer] %>"
                style="width: 5rem;">
            </td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div class="field">
      <label class="field__label">Pause Before Prayer (minutes)</label>
      <input type="number" name="pause_offset_minutes" class="field__input"
        min="0" max="30" value="<%= zone ? zone.pause_offset_minutes : 0 %>"
        style="width: 8rem;">
    </div>

    <div class="grid-2">
      <div class="field">
        <label class="field__label">Mode</label>
        <select name="mode" class="field__select">
          <option value="year-round" <%= !zone || zone.mode === 'year-round' ? 'selected' : '' %>>Year-round</option>
          <option value="ramadan-only" <%= zone && zone.mode === 'ramadan-only' ? 'selected' : '' %>>Ramadan only</option>
        </select>
      </div>
      <div class="field">
        <label class="field__label">Enabled</label>
        <select name="enabled" class="field__select">
          <option value="true" <%= !zone || zone.enabled ? 'selected' : '' %>>Yes</option>
          <option value="false" <%= zone && !zone.enabled ? 'selected' : '' %>>No</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Call to Prayer (Adhan) -->
  <div class="form-section" id="adhan-section">
    <div class="form-section__title">Call to Prayer (Adhan)</div>

    <div class="field">
      <label class="field__label">Enable Adhan</label>
      <select name="adhan_enabled" id="adhan-enabled" class="field__select" style="width: 8rem;">
        <option value="false" <%= !zone || !zone.adhan_enabled ? 'selected' : '' %>>No</option>
        <option value="true" <%= zone && zone.adhan_enabled ? 'selected' : '' %>>Yes</option>
      </select>
      <p class="text-muted" style="margin-top: var(--space-1); font-size: 0.8rem;">
        Plays a call to prayer track before each prayer time, then pauses for prayer.
      </p>
    </div>

    <div id="adhan-fields" style="<%= !zone || !zone.adhan_enabled ? 'opacity: 0.4; pointer-events: none;' : '' %>">
      <div class="field">
        <label class="field__label">Adhan Playlist</label>
        <select name="adhan_source_id" id="adhan-source" class="field__select">
          <option value="">Select playlist...</option>
        </select>
      </div>

      <div class="field">
        <label class="field__label">Default Music Source</label>
        <select name="default_source_id" id="default-source" class="field__select">
          <option value="">Select playlist or schedule...</option>
        </select>
        <p class="text-muted" style="margin-top: var(--space-1); font-size: 0.8rem;">
          The playlist or schedule to restore after prayer ends.
        </p>
      </div>

      <div class="field">
        <label class="field__label">Lead Time (minutes before prayer)</label>
        <input type="number" name="adhan_lead_minutes" class="field__input"
          min="1" max="15" value="<%= zone ? zone.adhan_lead_minutes : 5 %>"
          style="width: 8rem;">
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div style="display: flex; gap: var(--space-3); align-items: center; flex-wrap: wrap;">
    <button type="submit" class="btn btn--primary btn--lg"><%= zone ? 'Save Changes' : 'Add Zone' %></button>
    <% if (zone) { %>
      <button type="button" class="btn btn--danger" id="delete-btn">Delete Zone</button>
    <% } %>
    <a href="<%= basePath %>" class="btn btn--ghost">Cancel</a>
  </div>
</form>

<script>
  // Load zones for the customer's account (only on add form)
  document.addEventListener('DOMContentLoaded', () => {
    const zoneSelect = document.getElementById('zone-select');
    if (zoneSelect) {
      fetch('<%= basePath %>/api/soundtrack/zones')
        .then(r => r.json())
        .then(zones => {
          if (zones.length === 0) {
            zoneSelect.innerHTML = '<option value="">No sound zones found</option>';
            return;
          }
          zoneSelect.innerHTML = '<option value="">Select zone...</option>' +
            zones.map(z =>
              '<option value="' + z.id + '" data-location-id="' + z.locationId +
              '" data-location-name="' + z.locationName + '" data-zone-name="' + z.name + '">' +
              z.locationName + ' / ' + z.name + (z.isPaired ? '' : ' (unpaired)') +
              '</option>'
            ).join('');
        });

      zoneSelect.addEventListener('change', () => {
        const opt = zoneSelect.options[zoneSelect.selectedIndex];
        document.getElementById('location-id').value = opt.dataset.locationId || '';
        document.getElementById('location-name').value = opt.dataset.locationName || '';
        document.getElementById('zone-name').value = opt.dataset.zoneName || '';
      });
    }

    // Load library for adhan/default source dropdowns
    loadLibrary();
  });

  // Adhan toggle
  const adhanEnabled = document.getElementById('adhan-enabled');
  const adhanFields = document.getElementById('adhan-fields');
  if (adhanEnabled && adhanFields) {
    adhanEnabled.addEventListener('change', () => {
      const on = adhanEnabled.value === 'true';
      adhanFields.style.opacity = on ? '1' : '0.4';
      adhanFields.style.pointerEvents = on ? 'auto' : 'none';
    });
  }

  // Library loader for adhan/default source dropdowns
  function loadLibrary() {
    fetch('<%= basePath %>/api/soundtrack/library')
      .then(r => r.json())
      .then(lib => {
        const adhanSelect = document.getElementById('adhan-source');
        const defaultSelect = document.getElementById('default-source');
        const savedAdhan = '<%= zone ? (zone.adhan_source_id || "") : "" %>';
        const savedDefault = '<%= zone ? (zone.default_source_id || "") : "" %>';

        if (adhanSelect) {
          adhanSelect.innerHTML = '<option value="">Select playlist...</option>' +
            lib.playlists.map(p =>
              '<option value="' + p.id + '"' + (p.id === savedAdhan ? ' selected' : '') + '>' + p.name + '</option>'
            ).join('');
        }

        if (defaultSelect) {
          const allSources = [
            ...lib.playlists.map(p => ({ ...p, type: 'Playlist' })),
            ...lib.schedules.map(s => ({ ...s, type: 'Schedule' })),
          ];
          defaultSelect.innerHTML = '<option value="">Select playlist or schedule...</option>' +
            allSources.map(s =>
              '<option value="' + s.id + '"' + (s.id === savedDefault ? ' selected' : '') + '>' + s.name + ' (' + s.type + ')</option>'
            ).join('');
        }
      })
      .catch(() => {});
  }

  // Delete button
  const deleteBtn = document.getElementById('delete-btn');
  if (deleteBtn) {
    deleteBtn.addEventListener('click', () => {
      if (confirm('Delete this zone configuration? This cannot be undone.')) {
        deleteBtn.classList.add('btn--loading');
        deleteBtn.disabled = true;
        fetch('<%= basePath %>/api/zones/<%= zone ? zone.id : '' %>', { method: 'DELETE' })
          .then(() => location.href = '<%= basePath %>');
      }
    });
  }
</script>

<%- include('../_foot') %>
